trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - PLAN_DE_PRUEBAS.md
      - .gitignore

pr:
  branches:
    include:
      - main
      - develop

variables:
  nodeVersion: '20.x'
  pnpmVersion: '9.x'
  
pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: CI
    displayName: 'IntegraciÃ³n Continua'
    jobs:
      - job: Build_and_Test
        displayName: 'Build, Lint y Tests'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'ğŸ“¦ Instalar Node.js $(nodeVersion)'

          - script: |
              npm install -g pnpm@$(pnpmVersion)
              pnpm --version
            displayName: 'ğŸ“¦ Instalar pnpm'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_HOME)/store
              restoreKeys: |
                pnpm | "$(Agent.OS)"
            displayName: 'ğŸ’¾ Cache de dependencias pnpm'

          - script: |
              pnpm install --frozen-lockfile
            displayName: 'ğŸ“¥ Instalar dependencias'

          - script: |
              pnpm run format:check
            displayName: 'ğŸ¨ Verificar formato de cÃ³digo (Prettier)'
            continueOnError: 'true'

          - script: |
              pnpm run lint
            displayName: 'ğŸ” Linting (ESLint)'

          - script: |
              pnpm run build
            displayName: 'ğŸ—ï¸ Build del proyecto'

          - script: |
              pnpm run test:coverage
            displayName: 'ğŸ§ª Ejecutar pruebas unitarias (Vitest + Coverage)'

          - script: |
              pnpm exec playwright install --with-deps chromium
            displayName: 'ğŸŒ Instalar navegadores Playwright'

          - script: |
              pnpm run test:e2e
            displayName: 'ğŸ­ Ejecutar pruebas E2E (Playwright)'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/results.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Playwright E2E Tests'
            displayName: 'ğŸ“‹ Publicar resultados E2E'
            condition: succeededOrFailed()

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report'
              publishLocation: 'pipeline'
            displayName: 'ğŸ“‘ Publicar reporte Playwright'
            condition: succeededOrFailed()

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/dist'
              artifact: 'dist'
              publishLocation: 'pipeline'
            displayName: 'ğŸ“¦ Publicar artefactos de build'
            condition: succeeded()

  - stage: Deploy_Staging
    displayName: 'Deploy a Staging'
    dependsOn: CI
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: Deploy_to_Staging
        displayName: 'Desplegar a Staging'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: dist
                  displayName: 'ğŸ“¥ Descargar artefactos'

                - script: |
                    echo "Desplegando a entorno de Staging..."
                    ls -la $(Pipeline.Workspace)/dist
                  displayName: 'ğŸš€ Deploy a Staging'

  - stage: Deploy_Production
    displayName: 'Deploy a ProducciÃ³n'
    dependsOn: CI
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: Deploy_to_Production
        displayName: 'Desplegar a ProducciÃ³n'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: dist
                  displayName: 'ğŸ“¥ Descargar artefactos'
                  
                - script: |
                    echo "Desplegando a entorno de ProducciÃ³n..."
                    ls -la $(Pipeline.Workspace)/dist
                  displayName: 'ğŸš€ Deploy a ProducciÃ³n'
