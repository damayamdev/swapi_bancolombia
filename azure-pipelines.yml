# Pipeline de CI/CD para SWAPI Bancolombia
# React + Vite + TypeScript + Vitest + Playwright

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - PLAN_DE_PRUEBAS.md
      - .gitignore

pr:
  branches:
    include:
      - main
      - develop

variables:
  nodeVersion: '20.x'
  pnpmVersion: '9.x'
  
pool:
  vmImage: 'ubuntu-latest'

stages:
  # ==============================
  # STAGE 1: CI - Build y Testing
  # ==============================
  - stage: CI
    displayName: 'IntegraciÃ³n Continua'
    jobs:
      - job: Build_and_Test
        displayName: 'Build, Lint y Tests'
        steps:
          # InstalaciÃ³n de Node.js
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: 'ğŸ“¦ Instalar Node.js $(nodeVersion)'

          # InstalaciÃ³n de pnpm
          - script: |
              npm install -g pnpm@$(pnpmVersion)
              pnpm --version
            displayName: 'ğŸ“¦ Instalar pnpm'

          # Cache de dependencias de pnpm
          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_HOME)/store
              restoreKeys: |
                pnpm | "$(Agent.OS)"
            displayName: 'ğŸ’¾ Cache de dependencias pnpm'

          # InstalaciÃ³n de dependencias
          - script: |
              pnpm install --frozen-lockfile
            displayName: 'ğŸ“¥ Instalar dependencias'

          # VerificaciÃ³n de formato de cÃ³digo
          - script: |
              pnpm run format:check
            displayName: 'ğŸ¨ Verificar formato de cÃ³digo (Prettier)'
            continueOnError: 'true'

          # Linting
          - script: |
              pnpm run lint
            displayName: 'ğŸ” Linting (ESLint)'

          # CompilaciÃ³n TypeScript y Build
          - script: |
              pnpm run build
            displayName: 'ğŸ—ï¸ Build del proyecto'

          # Pruebas unitarias con coverage
          - script: |
              pnpm run test:coverage
            displayName: 'ğŸ§ª Ejecutar pruebas unitarias (Vitest + Coverage)'

          # Instalar navegadores para Playwright
          - script: |
              pnpm exec playwright install --with-deps chromium
            displayName: 'ğŸŒ Instalar navegadores Playwright'

          # Pruebas E2E
          - script: |
              pnpm run test:e2e
            displayName: 'ğŸ­ Ejecutar pruebas E2E (Playwright)'

          # Publicar resultados de Playwright
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results/results.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Playwright E2E Tests'
            displayName: 'ğŸ“‹ Publicar resultados E2E'
            condition: succeededOrFailed()

          # Publicar reporte HTML de Playwright
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report'
              publishLocation: 'pipeline'
            displayName: 'ğŸ“‘ Publicar reporte Playwright'
            condition: succeededOrFailed()

          # Publicar artefactos de build (dist)
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/dist'
              artifact: 'dist'
              publishLocation: 'pipeline'
            displayName: 'ğŸ“¦ Publicar artefactos de build'
            condition: succeeded()

  # ==============================
  # STAGE 2: CD - Deployment
  # ==============================
  - stage: Deploy_Staging
    displayName: 'Deploy a Staging'
    dependsOn: CI
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: Deploy_to_Staging
        displayName: 'Desplegar a Staging'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: dist
                  displayName: 'ğŸ“¥ Descargar artefactos'

                # AquÃ­ puedes agregar pasos especÃ­ficos de deployment
                # Ejemplos: Azure Static Web Apps, Azure App Service, S3, etc.
                - script: |
                    echo "Desplegando a entorno de Staging..."
                    ls -la $(Pipeline.Workspace)/dist
                  displayName: 'ğŸš€ Deploy a Staging'

  - stage: Deploy_Production
    displayName: 'Deploy a ProducciÃ³n'
    dependsOn: CI
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: Deploy_to_Production
        displayName: 'Desplegar a ProducciÃ³n'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: dist
                  displayName: 'ğŸ“¥ Descargar artefactos'

                # Deployment a producciÃ³n
                # Ejemplo para Azure Static Web Apps:
                # - task: AzureStaticWebApp@0
                #   inputs:
                #     app_location: '$(Pipeline.Workspace)/dist'
                #     azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)
                
                - script: |
                    echo "Desplegando a entorno de ProducciÃ³n..."
                    ls -la $(Pipeline.Workspace)/dist
                  displayName: 'ğŸš€ Deploy a ProducciÃ³n'
